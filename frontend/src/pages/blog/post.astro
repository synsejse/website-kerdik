---
import Layout from "../../layouts/Layout.astro";
import Container from "../../components/layout/Container.astro";
import Loading from "../../components/admin/common/Loading.astro";
import ChevronLeft from "../../components/icons/ChevronLeft.astro";
---

<Layout title="Blog príspevok">
  <article class="bg-gray-50 py-12 md:py-16">
    <Container>
      <div id="loading-post">
        <Loading text="Načítavam príspevok..." />
      </div>

      <div id="error-post" class="hidden text-center py-12">
        <p class="text-gray-600">Príspevok sa nenašiel.</p>
        <a href="/blog" class="inline-flex items-center gap-2 mt-4 text-primary hover:text-blue-600 font-bold transition-colors no-underline">
          <ChevronLeft class="h-5 w-5" />
          Späť na blog
        </a>
      </div>

      <div id="post-content" class="hidden max-w-4xl mx-auto"></div>
    </Container>
  </article>

  <template id="icon-chevron-left">
    <ChevronLeft class="h-5 w-5" />
  </template>

  <script>
    import { api } from "../../lib/api";
    import { markdownToHtml } from "../../utils/markdown";

    async function loadBlogPost() {
      const loading = document.getElementById("loading-post");
      const error = document.getElementById("error-post");
      const content = document.getElementById("post-content");

      if (!content) return;

      // Get slug from URL parameter
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');

      if (!slug) {
        if (error) error.classList.remove("hidden");
        if (loading) loading.classList.add("hidden");
        return;
      }

      try {
        const post = await api.blog.getBlogPostBySlug(slug);
        
        const createdDate = new Date(post.created_at);
        const updatedDate = new Date(post.updated_at);
        const formattedCreated = createdDate.toLocaleDateString("sk-SK", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const formattedUpdated = updatedDate.toLocaleDateString("sk-SK", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        document.title = post.title + " - Blog";

        content.innerHTML = `
          <header class="mb-8">
            <h1 class="m-0 mb-4 text-3xl md:text-4xl lg:text-5xl font-black text-gray-900 leading-tight tracking-tight">
              ${post.title}
            </h1>
            <div class="flex items-center gap-4 text-sm text-gray-500">
              <time datetime="${post.created_at}">
                ${formattedCreated}
              </time>
              ${post.updated_at !== post.created_at ? `<span>• Aktualizované: ${formattedUpdated}</span>` : ''}
            </div>
          </header>

          ${post.image_mime ? `
            <div class="mb-8">
              <img src="${api.blog.getBlogPostImageUrl(post.id)}" alt="${escapeHtml(post.title)}" class="w-full h-auto rounded-2xl shadow-lg">
            </div>
          ` : ''}

          ${post.excerpt ? `
            <div class="mb-8 p-6 bg-blue-50 border-l-4 border-primary rounded-r-lg">
              <div class="text-lg text-gray-700 italic m-0 prose max-w-none">
                ${markdownToHtml(post.excerpt)}
              </div>
            </div>
          ` : ''}

          <div class="prose prose-lg max-w-none">
            ${markdownToHtml(post.content)}
          </div>

          <div class="mt-12 pt-8 border-t border-gray-200">
            <a href="/blog" class="inline-flex items-center gap-2 text-primary hover:text-blue-600 font-bold transition-colors no-underline">
              <span class="icon-chevron-left"></span>
              Späť na blog
            </a>
          </div>
        `;

        // Replace icon placeholders with cloned templates
        const chevronTemplate = document.getElementById('icon-chevron-left') as HTMLTemplateElement;
        if (chevronTemplate && content) {
          content.querySelectorAll('.icon-chevron-left').forEach((placeholder) => {
            placeholder.replaceWith(chevronTemplate.content.cloneNode(true));
          });
        }

        content.classList.remove("hidden");
      } catch (e) {
        console.error("Error loading blog post:", e);
        if (error) error.classList.remove("hidden");
      } finally {
        if (loading) loading.classList.add("hidden");
      }
    }

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    loadBlogPost();
  </script>
</Layout>
