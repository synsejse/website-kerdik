---
import AdminLayout from "../../layouts/admin/Layout.astro";
import Trash from "../../components/icons/Trash.astro";
import Calendar from "../../components/icons/Calendar.astro";
import Phone from "../../components/icons/Phone.astro";
import Envelope from "../../components/icons/Envelope.astro";
import ArrowsRotate from "../../components/icons/ArrowsRotate.astro";
import ArrowLeft from "../../components/icons/ArrowLeft.astro";
import ArrowRight from "../../components/icons/ArrowRight.astro";
import ArchiveBox from "../../components/icons/ArchiveBox.astro";
import Clock from "../../components/icons/Clock.astro";
import User from "../../components/icons/User.astro";
import Undo from "../../components/icons/Undo.astro";
---
<AdminLayout title="Admin - Správy" showFooter={false}>
  <div class="min-h-screen bg-gray-50 flex flex-col font-sans">
    <main class="grow py-8 md:py-12 px-4">
      <div class="max-w-275 mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-8">
          <div>
            <h1
              class="m-0 text-3xl md:text-4xl font-black text-gray-900 tracking-tight relative inline-block pb-3 after:content-[''] after:absolute after:left-0 after:bottom-0 after:h-2 after:w-2/3 after:bg-linear-to-r after:from-primary after:to-blue-400 after:rounded-full"
            >
              Správy
            </h1>
            <p class="mt-4 text-xs text-gray-500 font-bold uppercase tracking-widest italic">
              Prehľad doručených kontaktov
            </p>
          </div>
          <div class="flex gap-4">
            <button
              id="refresh-btn"
              class="px-6 py-3 bg-primary hover:bg-[#0353e9] text-white font-black uppercase tracking-widest text-xs rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 group"
            >
              <ArrowsRotate class="h-4 w-4 transition-transform duration-500 group-hover:rotate-180" />
              Obnoviť zoznam
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
          <div class="flex space-x-8">
            <button
              id="active-tab"
              class="pb-4 px-1 text-sm font-black uppercase tracking-widest border-b-2 border-primary text-primary transition-colors relative group"
            >
              Aktívne správy
              <span id="active-count" class="ml-2 px-2 py-1 text-xs bg-primary text-white rounded-full">0</span>
            </button>
            <button
              id="archived-tab"
              class="pb-4 px-1 text-sm font-black uppercase tracking-widest text-gray-400 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors relative group flex items-center gap-2"
            >
              <ArchiveBox class="h-4 w-4" />
              Archív správ
              <span id="archived-count" class="ml-2 px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded-full">0</span>
            </button>
          </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-32 hidden">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-primary"></div>
          <p class="mt-6 text-gray-400 font-bold text-xs uppercase tracking-widest animate-pulse">Načítavam dáta...</p>
        </div>

        <!-- Active Messages Container -->
        <div id="active-container" class="space-y-6 md:space-y-8">
          <!-- Active messages will be loaded here -->
        </div>

        <!-- Archived Messages Container -->
        <div id="archived-container" class="space-y-6 md:space-y-8 hidden">
          <!-- Archived messages will be loaded here -->
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="hidden flex-wrap justify-center items-center gap-4 md:gap-6 mt-12">
          <button
            id="prev-page"
            class="flex items-center gap-2 px-4 md:px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-black uppercase tracking-widest text-gray-700 hover:bg-gray-50 hover:border-primary/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 group transition-all"
          >
            <ArrowLeft class="h-3 w-3 transition-transform group-hover:-translate-x-0.5 group-disabled:translate-x-0" />
            <span class="hidden sm:inline">Predchádzajúca</span>
            <span class="sm:hidden">Späť</span>
          </button>
          <span id="page-info" class="text-xs font-black uppercase tracking-widest text-gray-400">
            Strana <span id="current-page-num" class="text-primary">1</span>
          </span>
          <button
            id="next-page"
            class="flex items-center gap-2 px-4 md:px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-black uppercase tracking-widest text-gray-700 hover:bg-gray-50 hover:border-primary/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 group transition-all"
          >
            <span class="hidden sm:inline">Nasledujúca</span>
            <span class="sm:hidden">Ďalej</span>
            <ArrowRight class="h-3 w-3 transition-transform group-hover:translate-x-0.5 group-disabled:translate-x-0" />
          </button>
        </div>

        <!-- Empty States -->
        <div id="no-active-messages" class="hidden text-center py-32 bg-white border border-gray-100 rounded-3xl shadow-sm text-gray-400">
          <div class="flex justify-center mb-6 opacity-20">
            <Envelope class="h-20 w-20" />
          </div>
          <p class="font-bold text-sm uppercase tracking-widest italic">Momentálne nemáte žiadne aktívne správy.</p>
          <p class="mt-2 text-xs text-gray-400">Nové správy sa zobrazia tu.</p>
        </div>

        <div id="no-archived-messages" class="hidden text-center py-32 bg-white border border-gray-100 rounded-3xl shadow-sm text-gray-400">
          <div class="flex justify-center mb-6 opacity-20">
            <ArchiveBox class="h-20 w-20" />
          </div>
          <p class="font-bold text-sm uppercase tracking-widest italic">Archív správ je prázdny.</p>
          <p class="mt-2 text-xs text-gray-400">Archivované správy sa zobrazia tu.</p>
        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-gray-100 py-10">
      <div class="max-w-300 mx-auto px-4 text-center">
        <p class="text-gray-400 font-bold text-[10px] uppercase tracking-widest">&copy; {new Date().getFullYear()} SD Stavby - Administračný Panel</p>
      </div>
    </footer>
  </div>

  <script>
    import { api, type Message, type ArchivedMessage } from "../../lib/api";
    import { format } from "date-fns";
    import { sk } from "date-fns/locale";

    // Extend window with admin actions
    declare global {
      interface Window {
        archiveMessage?: (id: number) => Promise<void>;
        deleteMessage?: (id: number) => Promise<void>;
        restoreMessage?: (id: number) => Promise<void>;
        permanentlyDeleteArchivedMessage?: (id: number) => Promise<void>;
      }
    }

    // UI Elements (with proper typing)
    const activeTab = document.getElementById("active-tab") as HTMLButtonElement | null;
    const archivedTab = document.getElementById("archived-tab") as HTMLButtonElement | null;
    const activeContainer = document.getElementById("active-container") as HTMLElement | null;
    const archivedContainer = document.getElementById("archived-container") as HTMLElement | null;
    const loading = document.getElementById("loading") as HTMLElement | null;
    const noActiveMessages = document.getElementById("no-active-messages") as HTMLElement | null;
    const noArchivedMessages = document.getElementById("no-archived-messages") as HTMLElement | null;
    const paginationControls = document.getElementById("pagination-controls") as HTMLElement | null;
    const prevPageBtn = document.getElementById("prev-page") as HTMLButtonElement | null;
    const nextPageBtn = document.getElementById("next-page") as HTMLButtonElement | null;
    const currentPageNum = document.getElementById("current-page-num") as HTMLElement | null;
    const refreshBtn = document.getElementById("refresh-btn") as HTMLButtonElement | null;
    const activeCount = document.getElementById("active-count") as HTMLElement | null;
    const archivedCount = document.getElementById("archived-count") as HTMLElement | null;

    // State
    let currentView: "active" | "archived" = "active";
    let currentPage = 1;
    let activeTotal = 0;
    let archivedTotal = 0;

    // Tab switching
    if (activeTab) {
      activeTab.addEventListener("click", () => {
        if (currentView === "archived") {
          switchToActiveView();
        }
      });
    }

    if (archivedTab) {
      archivedTab.addEventListener("click", () => {
        if (currentView === "active") {
          switchToArchivedView();
        }
      });
    }

    function switchToActiveView(): void {
      currentView = "active";
      currentPage = 1;

      if (activeTab) {
        activeTab.classList.add("text-primary", "border-primary");
        activeTab.classList.remove("text-gray-400", "border-transparent");
      }
      if (archivedTab) {
        archivedTab.classList.add("text-gray-400", "border-transparent");
        archivedTab.classList.remove("text-primary", "border-primary");
      }

      activeContainer?.classList.remove("hidden");
      archivedContainer?.classList.add("hidden");
      noArchivedMessages?.classList.add("hidden");

      loadActiveMessages();
    }

    function switchToArchivedView(): void {
      currentView = "archived";
      currentPage = 1;

      if (archivedTab) {
        archivedTab.classList.add("text-primary", "border-primary");
        archivedTab.classList.remove("text-gray-400", "border-transparent");
      }
      if (activeTab) {
        activeTab.classList.add("text-gray-400", "border-transparent");
        activeTab.classList.remove("text-primary", "border-primary");
      }

      archivedContainer?.classList.remove("hidden");
      activeContainer?.classList.add("hidden");
      noActiveMessages?.classList.add("hidden");

      loadArchivedMessages();
    }

    // Load counts for both tabs
    async function loadAllCounts(): Promise<void> {
      try {
        const activeResponse = await api.admin.getMessages(1, 5);
        activeTotal = activeResponse.total;
        if (activeCount) activeCount.textContent = String(activeTotal);

        const archivedResponse = await api.admin.getArchivedMessages(1, 5);
        archivedTotal = archivedResponse.total;
        if (archivedCount) archivedCount.textContent = String(archivedTotal);
      } catch (error) {
        console.error("Failed to load counts:", error);
        if (activeCount) activeCount.textContent = "0";
        if (archivedCount) archivedCount.textContent = "0";
      }
    }

    // Load active messages
    async function loadActiveMessages(): Promise<void> {
      if (loading) loading.style.display = "block";
      noActiveMessages?.classList.add("hidden");
      noArchivedMessages?.classList.add("hidden");
      if (activeContainer) activeContainer.innerHTML = "";
      paginationControls?.classList.add("hidden");

      try {
        const response = await api.admin.getMessages(currentPage);
        const messages = response.data;

        if (messages.length === 0) {
          noActiveMessages?.classList.remove("hidden");
        } else {
          renderActiveMessages(messages);
          updatePagination(response.total, response.limit);
        }

        activeTotal = response.total;
        if (activeCount) activeCount.textContent = String(response.total);
      } catch (error) {
        console.error("Failed to load active messages:", error);
        noActiveMessages?.classList.remove("hidden");
      } finally {
        if (loading) loading.style.display = "none";
      }
    }

    // Load archived messages
    async function loadArchivedMessages(): Promise<void> {
      if (loading) loading.style.display = "block";
      noActiveMessages?.classList.add("hidden");
      noArchivedMessages?.classList.add("hidden");
      if (archivedContainer) archivedContainer.innerHTML = "";
      paginationControls?.classList.add("hidden");

      try {
        const response = await api.admin.getArchivedMessages(currentPage);
        const messages = response.data;

        if (messages.length === 0) {
          noArchivedMessages?.classList.remove("hidden");
        } else {
          renderArchivedMessages(messages);
          updatePagination(response.total, response.limit);
        }

        archivedTotal = response.total;
        if (archivedCount) archivedCount.textContent = String(response.total);
      } catch (error) {
        console.error("Failed to load archived messages:", error);
        noArchivedMessages?.classList.remove("hidden");
      } finally {
        if (loading) loading.style.display = "none";
      }
    }

    // Render active messages
    function renderActiveMessages(messages: Message[]): void {
      if (!activeContainer || messages.length === 0) return;

      messages.forEach((msg: Message) => {
        const date = new Date(msg.created_at);
        const formattedDate = format(date, "d. MMMM yyyy HH:mm", { locale: sk });

        const card = document.createElement("div");
        card.className =
          "bg-white p-6 md:p-8 rounded-2xl border border-gray-100 shadow-sm transition-all duration-300 hover:shadow-xl hover:border-primary/20";
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row justify-between lg:items-start gap-6 mb-6">
              <div class="space-y-4 min-w-0 flex-1">
                  <div class="flex flex-wrap items-center gap-3">
                      <span class="px-3 py-1 bg-blue-50 text-primary text-[10px] font-black uppercase tracking-widest rounded-full border border-blue-100">Nová Správa</span>
                      <span class="flex items-center gap-1.5 text-xs text-gray-400 font-bold uppercase tracking-wider">
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          ${formattedDate}
                      </span>
                  </div>
                  <h3 class="text-xl md:text-2xl font-black text-gray-900 tracking-tight break-words">${escapeHtml(msg.subject || "(Bez predmetu)")}</h3>
                  <div class="flex flex-wrap items-center gap-4 text-xs md:text-sm">
                      <div class="flex items-center gap-2 font-black text-gray-900 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                          </svg>
                          ${escapeHtml(msg.name)}
                      </div>
                      <a href="mailto:${escapeHtml(msg.email)}" class="text-primary font-bold hover:underline transition-colors break-all flex items-center gap-2">
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          ${escapeHtml(msg.email)}
                      </a>
                      ${msg.phone ? `
                          <a href="tel:${escapeHtml(msg.phone)}" class="text-gray-600 font-bold hover:text-gray-900 transition-colors flex items-center gap-2">
                              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                              </svg>
                              ${escapeHtml(msg.phone)}
                          </a>` : ""}
                  </div>
              </div>
              <div class="flex shrink-0 gap-3">
                  <button
                      onclick="window.archiveMessage && window.archiveMessage(${msg.id})"
                      class="px-5 py-2.5 bg-gray-50 border border-gray-200 text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all duration-300 flex items-center justify-center gap-2 text-[10px] font-black uppercase tracking-widest rounded-xl group"
                      title="Archivovať správu"
                  >
                      <svg class="h-4 w-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                      </svg>
                      Archivovať
                  </button>
                  <button
                      onclick="window.deleteMessage && window.deleteMessage(${msg.id})"
                      class="px-5 py-2.5 bg-gray-50 border border-gray-200 text-gray-400 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all duration-300 flex items-center justify-center gap-2 text-[10px] font-black uppercase tracking-widest rounded-xl"
                      title="Zmazať správu natrvalo"
                  >
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      Zmazať
                  </button>
              </div>
          </div>
          <div class="bg-gray-50 p-6 rounded-xl border-l-4 border-primary text-gray-700 whitespace-pre-wrap break-words leading-relaxed text-sm font-medium italic">
              ${escapeHtml(msg.message)}
          </div>
          `;
        activeContainer.appendChild(card);
      });
    }

    // Render archived messages
    function renderArchivedMessages(messages: ArchivedMessage[]): void {
      if (!archivedContainer || messages.length === 0) return;

      messages.forEach((msg: ArchivedMessage) => {
        const createdDate = new Date(msg.created_at);
        const archivedDate = new Date(msg.archived_at);
        const formattedCreated = format(createdDate, "d. MMMM yyyy HH:mm", { locale: sk });
        const formattedArchived = format(archivedDate, "d. MMMM yyyy HH:mm", { locale: sk });

        const card = document.createElement("div");
        card.className =
          "bg-white p-6 md:p-8 rounded-2xl border border-gray-100 shadow-sm transition-all duration-300 hover:shadow-xl hover:border-gray-300";
        card.innerHTML = `
          <div class="flex flex-col lg:flex-row justify-between lg:items-start gap-6 mb-6">
              <div class="space-y-4 min-w-0 flex-1">
                  <div class="flex flex-wrap items-center gap-3">
                      <span class="px-3 py-1 bg-gray-100 text-gray-600 text-[10px] font-black uppercase tracking-widest rounded-full border border-gray-200">Archivované</span>
                      <span class="flex items-center gap-1.5 text-xs text-gray-400 font-bold uppercase tracking-wider">
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          Archivované: ${formattedArchived}
                      </span>
                  </div>
                  <h3 class="text-xl md:text-2xl font-black text-gray-900 tracking-tight break-words">${escapeHtml(msg.subject || "(Bez predmetu)")}</h3>
                  <div class="flex flex-wrap items-center gap-4 text-xs md:text-sm">
                      <div class="flex items-center gap-2 font-black text-gray-900 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                          </svg>
                          ${escapeHtml(msg.name)}
                      </div>
                      <a href="mailto:${escapeHtml(msg.email)}" class="text-gray-600 font-bold hover:text-gray-900 transition-colors break-all flex items-center gap-2">
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          ${escapeHtml(msg.email)}
                      </a>
                      ${msg.phone ? `
                          <a href="tel:${escapeHtml(msg.phone)}" class="text-gray-600 font-bold hover:text-gray-900 transition-colors flex items-center gap-2">
                              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                              </svg>
                              ${escapeHtml(msg.phone)}
                          </a>` : ""}
                  </div>
                  <div class="flex items-center gap-4 text-xs text-gray-500">
                      <span class="flex items-center gap-1.5">
                          <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          Vytvorené: ${formattedCreated}
                      </span>
                  </div>
              </div>
              <div class="flex shrink-0 gap-3">
                  <button
                      onclick="window.restoreMessage && window.restoreMessage(${msg.original_id})"
                      class="px-5 py-2.5 bg-gray-50 border border-gray-200 text-gray-600 hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition-all duration-300 flex items-center justify-center gap-2 text-[10px] font-black uppercase tracking-widest rounded-xl group"
                      title="Obnoviť správu"
                  >
                      <svg class="h-4 w-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                      </svg>
                      Obnoviť
                  </button>
                  <button
                      onclick="window.permanentlyDeleteArchivedMessage && window.permanentlyDeleteArchivedMessage(${msg.id})"
                      class="px-5 py-2.5 bg-gray-50 border border-gray-200 text-gray-400 hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all duration-300 flex items-center justify-center gap-2 text-[10px] font-black uppercase tracking-widest rounded-xl"
                      title="Zmazať natrvalo"
                  >
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      Zmazať
                  </button>
              </div>
          </div>
          <div class="bg-gray-50 p-6 rounded-xl border-l-4 border-gray-300 text-gray-700 whitespace-pre-wrap break-words leading-relaxed text-sm font-medium italic">
              ${escapeHtml(msg.message)}
          </div>
          `;
        archivedContainer.appendChild(card);
      });
    }

    // Update pagination
    function updatePagination(total: number, limit: number): void {
      if (!paginationControls || !prevPageBtn || !nextPageBtn || !currentPageNum) return;

      const totalPages = Math.ceil(total / limit);

      if (totalPages > 1) {
        paginationControls.classList.remove("hidden");
        paginationControls.classList.add("flex");

        currentPageNum.textContent = String(currentPage);

        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      } else {
        paginationControls.classList.add("hidden");
        paginationControls.classList.remove("flex");
      }
    }

    // Helper functions
    function escapeHtml(text?: string | null): string {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Window functions for buttons
    window.archiveMessage = async function (id: number): Promise<void> {
      if (!confirm("Naozaj chcete archivovať túto správu?")) return;
      try {
        await api.admin.archiveMessage(id);
        await loadAllCounts();
        await loadActiveMessages();
      } catch (error) {
        console.error("Failed to archive message:", error);
        alert("Nepodarilo sa archivovať správu.");
      }
    };

    window.deleteMessage = async function (id: number): Promise<void> {
      if (!confirm("Naozaj chcete natrvalo zmazať túto správu? Táto akcia je nezvratná!")) return;
      try {
        await api.admin.deleteMessage(id);
        await loadAllCounts();
        await loadActiveMessages();
      } catch (error) {
        console.error("Failed to delete message:", error);
        alert("Nepodarilo sa zmazať správu.");
      }
    };

    window.restoreMessage = async function (id: number): Promise<void> {
      if (!confirm("Naozaj chcete obnoviť túto správu?")) return;
      try {
        await api.admin.restoreMessage(id);
        await loadAllCounts();
        await loadArchivedMessages();
      } catch (error) {
        console.error("Failed to restore message:", error);
        alert("Nepodarilo sa obnoviť správu.");
      }
    };

    window.permanentlyDeleteArchivedMessage = async function (id: number): Promise<void> {
      if (!confirm("Naozaj chcete natrvalo zmazať túto archivovanú správu? Táto akcia je nezvratná!")) return;
      try {
        await api.admin.permanentlyDeleteArchivedMessage(id);
        await loadAllCounts();
        await loadArchivedMessages();
      } catch (error) {
        console.error("Failed to delete archived message:", error);
        alert("Nepodarilo sa zmazať archivovanú správu.");
      }
    };

    // Event listeners
    refreshBtn?.addEventListener("click", () => {
      currentPage = 1;
      if (currentView === "active") {
        loadActiveMessages();
      } else {
        loadArchivedMessages();
      }
    });

    prevPageBtn?.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        if (currentView === "active") {
          loadActiveMessages();
        } else {
          loadArchivedMessages();
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    nextPageBtn?.addEventListener("click", () => {
      currentPage++;
      if (currentView === "active") {
        loadActiveMessages();
      } else {
        loadArchivedMessages();
      }
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Initialize: authentication is handled by the layout. Start loading counts and the active view.
    (async function initialize(): Promise<void> {
      try {
        await loadAllCounts();
        await loadActiveMessages();
      } catch (e) {
        console.error("Initialization error:", e);
      }
    })();
  </script>
</AdminLayout>
