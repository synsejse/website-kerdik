---
// Stats section with background image, dark overlay, animated counters
import StarIcon from "../icons/star.svg";
import UserGroupIcon from "../icons/user-group.svg";
import SquareCheckIcon from "../icons/square-check.svg";
import CalendarIcon from "../icons/calendar.svg";
import Container from "../layout/Container.astro";
---
<section class="stats-section" aria-labelledby="stats-title">
    <div class="overlay"></div>
    <Container>
        <div class="stats-container">
            <h2 id="stats-title" class="stats-title">VIAC o našej práci</h2>

            <div class="stats-grid">
                <article class="stat-item">
                    <div class="icon" aria-hidden="true">
                        <StarIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="value" data-target="100">0</div>
                    <div class="label">Kvalita služieb</div>
                </article>

                <article class="stat-item">
                    <div class="icon" aria-hidden="true">
                        <UserGroupIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="value" data-target="7500">0</div>
                    <div class="label">Spokojných klientov</div>
                </article>

                <article class="stat-item">
                    <div class="icon" aria-hidden="true">
                        <SquareCheckIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="value" data-target="300">0</div>
                    <div class="label">Ukončené projekty</div>
                </article>

                <article class="stat-item">
                    <div class="icon" aria-hidden="true">
                        <CalendarIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="value" data-target="15">0</div>
                    <div class="label">Rokov na trhu</div>
                </article>
            </div>
        </div>
    </Container>

    <script>
        // Count-up to target values when section becomes visible, fixed 3s duration.
        (function () {
            const run = () => {
                const section = document.querySelector('.stats-section');
                if (!section) return;

                const values = Array.from(section.querySelectorAll('.value'));
                let started = false;

                const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

                const animate = (el, target) => {
                    const duration = 3000; // exactly 3 seconds
                    const start = performance.now();
                    // Ensure we always start from 0 in UI
                    el.textContent = (0).toLocaleString('sk-SK');

                    const step = (now) => {
                        const p = Math.min(1, (now - start) / duration);
                        const eased = easeOutCubic(p);
                        const val = Math.round(eased * target);
                        el.textContent = val.toLocaleString('sk-SK');
                        if (p < 1) requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                };

                const startAll = () => {
                    if (started) return;
                    started = true;
                    values.forEach((el) => {
                        const target = parseInt(el.getAttribute('data-target') || '0', 10);
                        animate(el, target);
                    });
                };

                if ('IntersectionObserver' in window) {
                    const io = new IntersectionObserver((entries) => {
                        entries.forEach((e) => {
                            if (e.isIntersecting) {
                                startAll();
                                io.disconnect();
                            }
                        });
                    }, {threshold: 0.25});
                    io.observe(section);
                } else {
                    // Fallback: start immediately with animation (no IO support)
                    startAll();
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', run, {once: true});
            } else {
                run();
            }
        })();
    </script>
</section>

<style>
    .stats-section {
        position: relative;
        background-image: url('/images/banners/stats-banner.jpg');
        background-size: cover;
        background-position: center;
        color: #ffffff;
    }

    .overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .stats-container {
        position: relative;
    }

    .stats-title {
        margin: 0 0 1rem;
        font-size: clamp(1.4rem, 3.5vw, 2rem);
        letter-spacing: 0.02em;
        position: relative;
        display: inline-block;
        padding-bottom: 0.15em;
    }

    .stats-title::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: 0.02em;
        height: 0.22em;
        width: 56%;
        background: linear-gradient(90deg, #67a8ff 0%, #0f62fe 100%);
        border-radius: 999px;
        box-shadow: 0 2px 6px rgba(15, 98, 254, 0.35);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
    }

    .stat-item {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 14px;
        padding: 1rem;
        display: grid;
        gap: 0.35rem;
        align-content: start;
        min-height: 120px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(2px);
    }

    .icon {
        color: #93c5fd;
    }

    .value {
        font-size: clamp(1.6rem, 4.5vw, 2.2rem);
        font-weight: 800;
        line-height: 1.1;
        letter-spacing: 0.02em;
    }

    .label {
        font-size: 0.95rem;
        color: #e5e7eb;
    }


    @media (min-width: 900px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stats-title::after {
            width: 40%;
            height: 0.24em;
        }
    }

    @media (max-width: 520px) {
        .stat-item {
            min-height: 110px;
        }
    }
</style>
