---
// Stats section with background image, dark overlay, animated counters
import StarIcon from "../icons/Star.astro";
import UserGroupIcon from "../icons/UserGroup.astro";
import SquareCheckIcon from "../icons/SquareCheck.astro";
import CalendarIcon from "../icons/Calendar.astro";
import Container from "../layout/Container.astro";
---
<section class="relative bg-[url('/images/banners/stats-banner.jpg')] bg-cover bg-center text-white stats-section" aria-labelledby="stats-title">
    <div class="absolute inset-0 bg-black/50"></div>
    <Container className="relative">
        <div class="relative">
            <h2 id="stats-title" class="m-0 mb-6 text-2xl md:text-3xl lg:text-4xl font-bold leading-tight relative pb-2 inline-block tracking-tight after:content-[''] after:absolute after:left-0 after:bottom-0 after:h-1.5 md:after:h-2 after:w-[56%] lg:after:w-[40%] after:bg-linear-to-r after:from-[#67a8ff] after:to-primary after:rounded-full after:shadow-[0_2px_6px_rgba(15,98,254,0.35)]">VIAC o našej práci</h2>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <article class="bg-white/5 border border-white/20 rounded-2xl p-4 md:p-6 grid gap-2 shadow-xl backdrop-blur-sm transition-transform duration-300 hover:-translate-y-1">
                    <div class="text-[#93c5fd]" aria-hidden="true">
                        <StarIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="text-2xl md:text-3xl lg:text-4xl font-extrabold leading-tight tracking-tight value" data-target="100">0</div>
                    <div class="text-sm md:text-base text-gray-200">Kvalita služieb</div>
                </article>

                <article class="bg-white/5 border border-white/20 rounded-2xl p-4 md:p-6 grid gap-2 shadow-xl backdrop-blur-sm transition-transform duration-300 hover:-translate-y-1">
                    <div class="text-[#93c5fd]" aria-hidden="true">
                        <UserGroupIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="text-2xl md:text-3xl lg:text-4xl font-extrabold leading-tight tracking-tight value" data-target="7500">0</div>
                    <div class="text-sm md:text-base text-gray-200">Spokojných klientov</div>
                </article>

                <article class="bg-white/5 border border-white/20 rounded-2xl p-4 md:p-6 grid gap-2 shadow-xl backdrop-blur-sm transition-transform duration-300 hover:-translate-y-1">
                    <div class="text-[#93c5fd]" aria-hidden="true">
                        <SquareCheckIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="text-2xl md:text-3xl lg:text-4xl font-extrabold leading-tight tracking-tight value" data-target="300">0</div>
                    <div class="text-sm md:text-base text-gray-200">Ukončené projekty</div>
                </article>

                <article class="bg-white/5 border border-white/20 rounded-2xl p-4 md:p-6 grid gap-2 shadow-xl backdrop-blur-sm transition-transform duration-300 hover:-translate-y-1">
                    <div class="text-[#93c5fd]" aria-hidden="true">
                        <CalendarIcon width={28} height={28} fill="currentColor"/>
                    </div>
                    <div class="text-2xl md:text-3xl lg:text-4xl font-extrabold leading-tight tracking-tight value" data-target="15">0</div>
                    <div class="text-sm md:text-base text-gray-200">Rokov na trhu</div>
                </article>
            </div>
        </div>
    </Container>

    <script>
        // Count-up to target values when section becomes visible, fixed 3s duration.
        (function () {
            const run = () => {
                const section = document.querySelector('.stats-section');
                if (!section) return;

                const values = Array.from(section.querySelectorAll('.value')) as HTMLElement[];
                let started = false;

                const easeOutCubic = (t: number) => 1 - Math.pow(1 - t, 3);

                const animate = (el: HTMLElement, target: number) => {
                    const duration = 3000; // exactly 3 seconds
                    const start = performance.now();
                    // Ensure we always start from 0 in UI
                    el.textContent = (0).toLocaleString('sk-SK');

                    const step = (now: number) => {
                        const p = Math.min(1, (now - start) / duration);
                        const eased = easeOutCubic(p);
                        const val = Math.round(eased * target);
                        el.textContent = val.toLocaleString('sk-SK');
                        if (p < 1) requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                };

                const startAll = () => {
                    if (started) return;
                    started = true;
                    values.forEach((el) => {
                        const target = parseInt(el.getAttribute('data-target') || '0', 10);
                        animate(el, target);
                    });
                };

                if ('IntersectionObserver' in window) {
                    const io = new IntersectionObserver((entries) => {
                        entries.forEach((e) => {
                            if (e.isIntersecting) {
                                startAll();
                                io.disconnect();
                            }
                        });
                    }, {threshold: 0.25});
                    io.observe(section);
                } else {
                    // Fallback: start immediately with animation (no IO support)
                    startAll();
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', run, {once: true});
            } else {
                run();
            }
        })();
    </script>
</section>

