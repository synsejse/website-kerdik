---
// Hero Carousel component with image backgrounds and content slides
import ArrowLeftIcon from "../icons/ArrowLeft.astro";
import ArrowRightIcon from "../icons/ArrowRight.astro";

interface Slide {
    image: string;
    title: string;
    description: string;
}

const slides: Slide[] = [
    {
        image: "/images/carousel/carousel-01.jpg",
        title: "REVITALIZÁCIA RODINNÝCH DOMOV",
        description:
            "Výstavba rodinných domov na krúč, rekonštrukcie, zateplenie, fasády, okná, dvere. Komplexná revitalizácia rodinných domov.",
    },
    {
        image: "/images/carousel/carousel-02.jpg",
        title: "KOMPLEXNÁ REVITALIZÁCIA BYTOVÝCH DOMOV",
        description:
            "Komplexná revitalizácia bytového domu obsahuje zateplenie obvodového plášťa, termoizoláciu ...",
    },
    {
        image: "/images/carousel/carousel-03.jpg",
        title: "S NAŠOU STRECHOU BUDETE V SUCHU",
        description:
            "Izolácie, zateplenie a rekonštrukcie plochých striech bytových domov. Výstavba všetkých typov striech bytových a rodinných domov.",
    },
    {
        image: "/images/carousel/carousel-04.jpg",
        title: "MODERNÉ RIADENIE NAJMODERNEJŠIE TECHNOLÓGIE",
        description:
            "Držime krok s dobou, zákazníkom ponúkame najmodernejšie technológie.",
    },
];
---

<section
    class="h-95 md:h-[60vh] lg:h-[70vh] max-h-175 relative overflow-hidden hero-carousel"
>
    <div class="relative h-full carousel-container">
        <div class="relative h-full slides-wrapper">
            {
                slides.map((slide, index) => (
                    <div
                        class:list={[
                            "absolute inset-0 transition-opacity duration-1000 ease-in-out slide group",
                            index === 0 ? "opacity-100 active" : "opacity-0",
                        ]}
                        data-slide={index}
                    >
                        <img
                            src={slide.image}
                            alt={slide.title}
                            class="w-full h-full object-cover block transition-transform duration-[10s] ease-linear group-[.active]:scale-110"
                            loading="lazy"
                        />
                        <div class="absolute inset-0 bg-linear-to-b from-black/60 via-black/20 to-black/70" />
                        <div class="absolute inset-0 flex flex-col justify-center items-center text-white text-center px-4 md:px-16 lg:px-32">
                            <h1 class="m-0 mb-4 font-extrabold tracking-tight leading-tight text-3xl md:text-5xl lg:text-6xl drop-shadow-lg translate-y-8 opacity-0 transition-all duration-700 ease-out group-[.active]:translate-y-0 group-[.active]:opacity-100 delay-100">
                                {slide.title}
                            </h1>
                            <p class="m-0 mb-8 max-w-3xl text-base md:text-lg lg:text-xl text-gray-100 drop-shadow-md translate-y-8 opacity-0 transition-all duration-700 ease-out group-[.active]:translate-y-0 group-[.active]:opacity-100 delay-300">
                                {slide.description}
                            </p>
                            <div class="translate-y-8 opacity-0 transition-all duration-700 ease-out group-[.active]:translate-y-0 group-[.active]:opacity-100 delay-500">
                                <a
                                    href="/about"
                                    class="inline-flex items-center justify-center gap-2 px-6 md:px-8 py-3 md:py-4 rounded-full bg-primary text-white no-underline font-bold text-sm md:text-base tracking-wide transition-all duration-300 shadow-[0_6px_20px_rgba(15,98,254,0.35)] hover:bg-[#0b53d6] hover:shadow-[0_8px_25px_rgba(15,98,254,0.45)] hover:-translate-y-1 active:scale-95"
                                >
                                    <span>Dozvedieť sa viac</span>
                                    <ArrowRightIcon width={16} height={16} fill="currentColor" />
                                </a>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <div
            class="absolute inset-0 flex items-center justify-between pointer-events-none px-4 z-20"
        >
            <button
                class="carousel-btn pointer-events-auto bg-black/45 text-white border-none w-11 h-11 rounded-full inline-flex items-center justify-center cursor-pointer transition-colors duration-200 hover:bg-black/60 prev"
                aria-label="Predchádzajúci slide"
            >
                <ArrowLeftIcon width={20} height={20} fill="currentColor" />
            </button>
            <button
                class="carousel-btn pointer-events-auto bg-black/45 text-white border-none w-11 h-11 rounded-full inline-flex items-center justify-center cursor-pointer transition-colors duration-200 hover:bg-black/60 next"
                aria-label="Nasledujúci slide"
            >
                <ArrowRightIcon width={20} height={20} fill="currentColor" />
            </button>
        </div>

        <div
            class="absolute left-1/2 bottom-4.5 -translate-x-1/2 flex gap-1.5 z-20"
        >
            {
                slides.map((_, index) => (
                    <button
                        class="w-2 h-2 rounded-full border-none cursor-pointer dot bg-white/65 aria-current:bg-white transition-colors duration-300"
                        data-slide={index}
                        aria-label={`Slide ${index + 1}`}
                        aria-current={index === 0 ? "true" : "false"}
                    />
                ))
            }
        </div>

        <div
            class="absolute left-0 right-0 bottom-0 h-0.75 bg-linear-to-r from-[#67a8ff] to-primary opacity-90 w-0 transition-[width] duration-200 linear carousel-progress-bar"
            role="progressbar"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="0"
        >
        </div>
    </div>
</section>

<style>
    /* We keep only the classes that need to be toggled by JS but hard to do purely with classes */
    .slide.active {
        opacity: 1 !important;
    }
</style>

<script>
    // Progressive enhancement for the hero carousel
    (function () {
        if (typeof window === "undefined" || typeof document === "undefined")
            return;

        const ready = (fn: () => void) => {
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", fn, {
                    once: true,
                });
            } else {
                fn();
            }
        };

        ready(() => {
            const root = document.querySelector(".hero-carousel");
            if (!root) return;

            const wrapper = root.querySelector(".slides-wrapper");
            const slides = wrapper
                ? Array.from(wrapper.querySelectorAll(".slide"))
                : [];
            const btnPrev = root.querySelector(".carousel-btn.prev");
            const btnNext = root.querySelector(".carousel-btn.next");
            const dots = Array.from(root.querySelectorAll(".dot"));
            const bar = root.querySelector(
                ".carousel-progress-bar",
            ) as HTMLElement | null;
            const container = root.querySelector(".carousel-container") || root;

            if (!slides.length) return;

            let index = 0;
            let timer: number | null = null;
            const interval = 5000; // 5s per slide
            const prefersReduced = window.matchMedia(
                "(prefers-reduced-motion: reduce)",
            ).matches;
            let isPaused = false;

            const setActive = (i: number) => {
                index = (i + slides.length) % slides.length;
                slides.forEach((s, si) => {
                    if (si === index) {
                        s.classList.add("active", "opacity-100");
                        s.classList.remove("opacity-0");
                        s.removeAttribute("aria-hidden");
                    } else {
                        s.classList.remove("active", "opacity-100");
                        s.classList.add("opacity-0");
                        s.setAttribute("aria-hidden", "true");
                    }
                });
                dots.forEach((d, di) => {
                    const isActive = di === index;
                    d.setAttribute("aria-current", isActive ? "true" : "false");
                    if (isActive) {
                        d.classList.add("bg-white");
                        d.classList.remove("bg-white/65");
                    } else {
                        d.classList.remove("bg-white");
                        d.classList.add("bg-white/65");
                    }
                });
                if (bar) {
                    // Reset progress bar instantly then allow it to grow again
                    bar.style.transition = "none";
                    bar.style.width = "0%";
                    bar.setAttribute("aria-valuenow", "0");
                    // Force reflow to apply the reset width before animating
                    // eslint-disable-next-line @typescript-eslint/no-unused-expressions
                    void bar.offsetWidth;
                    bar.style.transition = prefersReduced
                        ? "none"
                        : `width ${interval}ms linear`;
                    if (!isPaused && !prefersReduced) {
                        requestAnimationFrame(() => {
                            bar.style.width = "100%";
                            bar.setAttribute("aria-valuenow", "100");
                        });
                    }
                }
            };

            const next = () => setActive(index + 1);
            const prev = () => setActive(index - 1);

            const clear = () => {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
            };

            const schedule = () => {
                if (prefersReduced || isPaused) return;
                clear();
                timer = window.setTimeout(() => {
                    next();
                    schedule();
                }, interval);
            };

            // Event bindings
            btnNext?.addEventListener("click", () => {
                next();
                schedule();
            });
            btnPrev?.addEventListener("click", () => {
                prev();
                schedule();
            });
            dots.forEach((d, di) =>
                d.addEventListener("click", () => {
                    setActive(di);
                    schedule();
                }),
            );

            const pause = () => {
                isPaused = true;
                clear();
                if (bar) {
                    // Keep current width, stop transition
                    const computed = getComputedStyle(bar);
                    const widthPx = parseFloat(computed.width);
                    const parentWidth = bar.parentElement
                        ? bar.parentElement.clientWidth
                        : 1;
                    const pct = Math.max(
                        0,
                        Math.min(100, (widthPx / parentWidth) * 100),
                    );
                    bar.style.transition = "none";
                    bar.style.width = pct + "%";
                }
            };
            const resume = () => {
                isPaused = false;
                if (!prefersReduced) {
                    // resume bar animation to end within remaining time – simplify by restarting cycle
                    setActive(index);
                    schedule();
                }
            };

            container.addEventListener("mouseenter", pause);
            container.addEventListener("mouseleave", resume);
            container.addEventListener("focusin", pause);
            container.addEventListener("focusout", resume);

            document.addEventListener("visibilitychange", () => {
                if (document.hidden) pause();
                else resume();
            });

            // Initialize
            // Mark roles for accessibility
            wrapper?.setAttribute("role", "list");
            slides.forEach((s) => s.setAttribute("role", "listitem"));
            setActive(0);
            schedule();
        });
    })();
</script>
